<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Fivox: Rescaling output voxel values</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Fivox
   &#160;<span id="projectnumber">0.6.0</span>
   </div>
   <div id="projectbrief">ITK library to sample events into regular volumes</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('rescaleOutput.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Rescaling output voxel values </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Since Fivox makes all the computations in floating point values, and supports different output types in the voxelize tool (just uint8 in the Livre DataSource), we need a way to correctly rescale the resulting values, based on the input data range and the output type range.</p>
<h2>Requirements</h2>
<ul>
<li>The internal computations should always be done in floating point values.</li>
<li>The data source for Livre must always convert the resulting volume from float to uint8_t values.</li>
<li>The voxelize tool will always write a volume in the specified output data type, converting it from float if needed.</li>
<li>The process of rescaling the volume data should always consider the output min and max values (known for each data type, e.g. 0-255 for uint8_t), and the data range derived from the input (min and max values present after the voxelization process in floating point values).</li>
<li>The conversion should always be done at the end of the process, after all the events' contribution has been considered to compute each voxel's value.</li>
<li>The min and max values of the data range derived from the input should be defined from the beginning, based on biological values and/or actual data. Since this is very hard to know in advance, specially for time-dependent data, a way to manually define this values should be provided. In any case, there should be default values.</li>
</ul>
<h2>Implementation</h2>
<p>Floating point values are already used along the whole process. And the voxelize tool is already taking care of the rescaling when the output data type is different than float.</p>
<p>In the EventFunctor (base class for the functors) there is a _scale method, used on each voxel to scale and clamp the value to the output data range. There are several problems with the current implementation (see fieldFunctor, for example):</p>
<ul>
<li>_scale assumes that the value is always normalized between 0 and 1, which might not be true, depending on the value of the 'magnitude' parameter.</li>
<li>In the case of voltages, it's always shifting the event values by brion::MINIMUM_VOLTAGE, to make all the values positive. This is wrong, as soon as we start adding voltages together for the computation of one specific voxel, we need to know their sign.</li>
</ul>
<p>The new implementation should get rid of these shift and scale operations in the functors, and use always the raw values of the report (or the result of the corresponding operation for an specific use case, e.g. LFP). All the conversion operations should be done only at the end of the process, once we make sure that the conversion won't affect the result of the computation.</p>
<p>The 'magnitude' parameter in the input URI is not enough for a correct rescaling operation. It was added with the intention to hold the value for the input data range, but this assumes that the starting value is 0, incorrect as soon as we start dealing with summations of voltages with different signs, for example.</p>
<p>So two new parameters should be added, 'inputMin' and 'inputMax'. And potentially remove the 'magnitude'. Example: </p><pre class="fragment">voxelize --volume fivoxlfp:///path/to/BlueConfig?report=currentReport&amp;target=targetName&amp;inputMin=-50&amp;inputMax=100
</pre><p>The operation to be performed in order to rescale a value from the input data range to an output data type range is as follows: </p><pre class="fragment">outputValue = (inputValue - inputMin) * (outputMax - outputMin) / (inputMax - inputMin) + outputMin
</pre><h2>Issues</h2>
<h3>1: Rescale on the full volume or in the functor (on each voxel)?</h3>
<p>Resolved: Rescale the full volume at once, after it's been generated.</p>
<p>We can do this operation at the end of the functor, once the summation has been done for a specific voxel, but we can also do it at the very end, once the full volume has been generated. ITK provides a filter that does this for us (IntensityWindowingImageFilter), so we can make use of it easily, adding this rescale filter as an additional step between the generation of the float volume and its final use (writing in the case of the voxelize tool, or passing it to Livre in the case of the data source).</p>
<p>Update: Rescale in the functor (on each voxel).</p>
<p>After a closer review, we noticed the performance implications of using a FloatVolume in the Livre data source. The only acceptable solution in that case is to use a ByteVolume from the beginning, so the scaling needs to be done in the functors. In that case, the ITK filter mentioned above would only be used in the voxelize app, and the new solution would implement the same behavior inside the EventFunctor class, deriving all the functors from it. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="Features.html">Feature specifications</a></li>
    <li class="footer">Generated on Sat Dec 10 2016 05:16:33 for Fivox by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
