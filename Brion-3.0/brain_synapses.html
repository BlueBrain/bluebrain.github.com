<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Brion: Synapse support in Brain</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Brion
   &#160;<span id="projectnumber">3.0.0</span>
   </div>
   <div id="projectbrief">The Blue Brain C++ I/O library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('brain_synapses.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Synapse support in Brain </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The low-level data access for synapses provided by Brion needs a complementary API in Brain to support various common higher-level uses cases, like semantic synapse object access or full-circuit synapse density voxelization, to name the two extremes.</p>
<h2>Requirements</h2>
<ul>
<li>Semantic synapse objects that give read-access to all properties</li>
<li>Array access which allows vectorization</li>
<li>Filtering of synapses for pathway use case (projected synapses of two targets)</li>
<li>Lazy-loading to support out-of-core scenarios</li>
<li>User-transparent KVS caching</li>
</ul>
<h2>New dependencies</h2>
<p>None</p>
<h2>API</h2>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespacebrain.html">brain</a></div><div class="line">{</div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Synapse GID.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * The GID of a synapse is the a tuple of two numbers:</span></div><div class="line"><span class="comment">     * - The GID of the post-synaptic cell.</span></div><div class="line"><span class="comment">     * - The index of the synapse in the array of afferent contacts</span></div><div class="line"><span class="comment">     *   of the post-synaptic cell before pruning/filtering.</span></div><div class="line"><span class="comment">     * GIDs are invariant regardless of how the structural touches are</span></div><div class="line"><span class="comment">     * converted into functional synapses during circuit building.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">typedef</span> std::pair&lt; uint32_t, size &gt; <a class="code" href="namespacebrain.html#af19fb16673bf58718117c03774b1b247">SynapseGID</a>;</div><div class="line"></div><div class="line">    <span class="comment">// loading of data during SynapseStream.read(), otherwise load happens on</span></div><div class="line">    <span class="comment">// first touch</span></div><div class="line">    <span class="keyword">enum</span> SynapsesPrefetch</div><div class="line">    {</div><div class="line">        SP_NONE = 0,            <span class="comment">// only loads pre- and post GIDs</span></div><div class="line">        SP_ATTRIBUTES = 1 &lt;&lt; 0, <span class="comment">// topological information (section, segment,</span></div><div class="line">                                <span class="comment">// distance) and electrical attributes</span></div><div class="line">        SP_POSITIONS = 1 &lt;&lt; 1,  <span class="comment">// pre/post surface/center positions</span></div><div class="line">        SP_ALL = SP_ATTRIBUTES | SP_POSITIONS</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">class </span>Circuit</div><div class="line">{</div><div class="line">    <span class="comment">// max count for read is gids.size()</span></div><div class="line">    SynapsesStream <a class="code" href="classbrain_1_1_circuit.html#a75f300dea500c142ec5f3ee1c1d2456a">getAfferentSynapses</a>( <span class="keyword">const</span> GIDSet&amp; gids,</div><div class="line">                                     SynapsesPrefetch prefetch = SP_ALL ) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="comment">// max count for read is gids.size()</span></div><div class="line">    SynapsesStream <a class="code" href="classbrain_1_1_circuit.html#acd51c99352dcde8dad828891aa483b81">getEfferentSynapses</a>( <span class="keyword">const</span> GIDSet&amp; gids,</div><div class="line">                                     SynapsesPrefetch prefetch = SP_ALL ) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="comment">// max count for read is min(preGIDs.size(), postGIDs.size())</span></div><div class="line">    SynapsesStream <a class="code" href="classbrain_1_1_circuit.html#a8096625c8fd6ab4d40a2ab672bc62fbd">getProjectedSynapses</a>( <span class="keyword">const</span> GIDSet&amp; preGIDs,</div><div class="line">                                         <span class="keyword">const</span> GIDSet&amp; postGIDs,</div><div class="line">                                     SynapsesPrefetch prefetch = SP_ALL ) <span class="keyword">const</span>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// read-only, moveable proxy object of data storage in Synapses container</span></div><div class="line"><span class="keyword">class </span>Synapse</div><div class="line">{</div><div class="line">    uint32_t preGID() <span class="keyword">const</span>;</div><div class="line">    uint32_t preSectionID() <span class="keyword">const</span>;</div><div class="line">    uint32_t preSegmentID() <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">float</span> preDistance() <span class="keyword">const</span>;</div><div class="line">    Vector3f preSurfacePosition() <span class="keyword">const</span>;</div><div class="line">    Vector3f preCenterPosition() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    uint32_t postGID() <span class="keyword">const</span>;</div><div class="line">    uint32_t postSectionID() <span class="keyword">const</span>;</div><div class="line">    uint32_t postSegmentID() <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">float</span> postDistance() <span class="keyword">const</span>;</div><div class="line">    Vector3f postSurfacePosition() <span class="keyword">const</span>;</div><div class="line">    Vector3f postCenterPosition() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <a class="code" href="namespacebrain.html#af19fb16673bf58718117c03774b1b247">SynapseGID</a> gid() <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">float</span> conductance() <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">float</span> utilization() <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">float</span> depression() <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">float</span> facilitation() <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">float</span> decay() <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">int</span> efficacy() <span class="keyword">const</span>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// read-only, moveable, copyable, thread-safe</span></div><div class="line"><span class="keyword">class </span>Synapses</div><div class="line">{</div><div class="line">    <span class="comment">// conversion ctor; read all synapses from selected GIDs into memory</span></div><div class="line">    Synapses( <span class="keyword">const</span> SynapsesStream&amp; );</div><div class="line"></div><div class="line">    <span class="keywordtype">size_t</span> size() <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">bool</span> empty() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> operator==( <span class="keyword">const</span> Synapses&amp; rhs ) <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">bool</span> operator!=( <span class="keyword">const</span> Synapses&amp; rhs ) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    const_iterator begin() <span class="keyword">const</span>;</div><div class="line">    const_iterator end() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> Synapse&amp; operator[]( <span class="keywordtype">size_t</span> ) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span>* index() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> uint32_t* preGID() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> uint32_t* preSectionID() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> uint32_t* preSegmentID() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* preDistance() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* preSurfacePositionX() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* preSurfacePositionY() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* preSurfacePositionZ() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* preCenterPositionX() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* preCenterPositionY() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* preCenterPositionZ() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> uint32_t* postGID() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> uint32_t* postSectionID() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> uint32_t* postSegmentID() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* postDistance() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* postSurfacePositionX() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* postSurfacePositionY() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* postSurfacePositionZ() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* postCenterPositionX() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* postCenterPositionY() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* postCenterPositionZ() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span>* indices() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* conductance() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* utilization() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* depression() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* facilitation() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* decay() <span class="keyword">const</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span>* efficacy() <span class="keyword">const</span>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// sequentially &amp; forwarding iteration through synapses for any number of GIDs</span></div><div class="line"><span class="comment">// not thread-safe, but reentrant</span></div><div class="line"><span class="keyword">class </span>SynapsesStream</div><div class="line">{</div><div class="line">    <span class="keywordtype">bool</span> eos() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Remaining count reads before eos()</span></div><div class="line">    <span class="comment">// equals to max - current, max determined by get..Synapses() in</span></div><div class="line">    <span class="comment">// brain::Circuit</span></div><div class="line">    <span class="keywordtype">size_t</span> getRemaining() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="comment">// - async load of synapses for count cells</span></div><div class="line">    <span class="comment">// - no order guarantee</span></div><div class="line">    <span class="comment">// - resulting Synapses can be empty</span></div><div class="line">    <span class="comment">// - count will be clamped if count &gt; getRemaining()</span></div><div class="line">    std::future&lt; Synapses &gt; read( <span class="keywordtype">size_t</span> count = 1 ) <span class="keyword">const</span>;</div><div class="line">};</div></div><!-- fragment --><h2>File format</h2>
<p>Uses existing nrn* files</p>
<h2>Examples</h2>
<h3>Stream synapse positions for pathway density voxelization</h3>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="classbrain_1_1_circuit.html">brain::Circuit</a> circuit;</div><div class="line"><span class="keyword">const</span> <a class="code" href="classbrain_1_1_synapses_stream.html">brain::SynapsesStream</a>&amp; stream =</div><div class="line">   circuit.<a class="code" href="classbrain_1_1_circuit.html#a8096625c8fd6ab4d40a2ab672bc62fbd">getProjectedSynapses</a>( circuit.<a class="code" href="classbrain_1_1_circuit.html#a36ee80e8f35795978c648acfd79253a5">getGIDs</a>( <span class="stringliteral">&quot;mtypetarget_1&quot;</span> ),</div><div class="line">                                 circuit.<a class="code" href="classbrain_1_1_circuit.html#a36ee80e8f35795978c648acfd79253a5">getGIDs</a>( <span class="stringliteral">&quot;mtypetarget_2&quot;</span> ));</div><div class="line">std::future&lt; brain::Synapses &gt; future = stream.<a class="code" href="classbrain_1_1_synapses_stream.html#a6797d5dba82d6ea60cfe60ca838211d2">read</a>();</div><div class="line"><span class="keywordflow">while</span>( !stream.<a class="code" href="classbrain_1_1_synapses_stream.html#a94d6a47d3b66064f6269d1f2c65300aa">eos</a>( ))</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classbrain_1_1_synapses.html">brain::Synapses</a> synapses = future.get();</div><div class="line">    future = stream.<a class="code" href="classbrain_1_1_synapses_stream.html#a6797d5dba82d6ea60cfe60ca838211d2">read</a>(); <span class="comment">// fetch next</span></div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* __restrict__ posx = synapses.preSurfacePositionX();</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* __restrict__ posy = synapses.preSurfacePositionY();</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span>* __restrict__ posz = synapses.preSurfacePositionZ();</div><div class="line">    <span class="keywordflow">for</span>( <span class="keywordtype">size_t</span> i = 0; i &lt; synapses.<a class="code" href="classbrain_1_1_synapses.html#a0b9ad156a0f451db5eada7365451f7e9">size</a>(); ++i )</div><div class="line">        doVoxelization( posx[i], posy[i], posz[i] );</div><div class="line">}</div></div><!-- fragment --><h3>Access all afferent synapses of a GIDSet</h3>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="classbrain_1_1_circuit.html">brain::Circuit</a> circuit;</div><div class="line"><span class="keyword">const</span> <a class="code" href="classbrain_1_1_synapses.html">brain::Synapses</a>&amp; synapses =</div><div class="line">    circuit.<a class="code" href="classbrain_1_1_circuit.html#a75f300dea500c142ec5f3ee1c1d2456a">getAfferentSynapses</a>( circuit.<a class="code" href="classbrain_1_1_circuit.html#a36ee80e8f35795978c648acfd79253a5">getGIDs</a>( <span class="stringliteral">&quot;Layer1&quot;</span> ));</div><div class="line"><span class="keywordflow">for</span>( <span class="keyword">const</span> <span class="keyword">auto</span>&amp; synapse : synapses )</div><div class="line">    std::cout &lt;&lt; synapse.postGID() &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; synapse.decay() &lt;&lt; std::endl;</div></div><!-- fragment --><h3>Retrograde projection</h3>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="classbrain_1_1_circuit.html">brain::Circuit</a> circuit;</div><div class="line"><span class="keyword">const</span> <a class="code" href="namespacebrion.html#a357e1817d1c46828b8a3d2ac91f635bc">brion::GIDSet</a>&amp; preNeurons = circuit.<a class="code" href="classbrain_1_1_circuit.html#a36ee80e8f35795978c648acfd79253a5">getGIDs</a>( <span class="stringliteral">&quot;Layer1&quot;</span> );</div><div class="line"><span class="keyword">const</span> <a class="code" href="namespacebrion.html#a357e1817d1c46828b8a3d2ac91f635bc">brion::GIDSet</a> postNeuron = { 1 };</div><div class="line"><span class="keyword">const</span> <a class="code" href="classbrain_1_1_synapses.html">brain::Synapses</a>&amp; synapses =</div><div class="line">    circuit.<a class="code" href="classbrain_1_1_circuit.html#a8096625c8fd6ab4d40a2ab672bc62fbd">getProjectedSynapses</a>( preNeurons, postNeuron );</div><div class="line">BOOST_CHECK( !synapses.<a class="code" href="classbrain_1_1_synapses.html#a7e678a61149c15e862817857837b2d49">empty</a>( ));</div><div class="line">BOOST_CHECK_EQUAL( synapses.<a class="code" href="classbrain_1_1_synapses.html#a0b9ad156a0f451db5eada7365451f7e9">size</a>(), 5 );</div></div><!-- fragment --><h2>Implementation</h2>
<ul>
<li>Data owned by container in the form of the arrays (transformed from SynapseMatrix), loaded upon construction wrt prefetch, lazy on first touch except for pre- and postGID for connectivity queries and to fulfill the contract for size().</li>
<li>Synapse object stores index to get data from (parenting) container, triggers lazy loading on first touch.</li>
<li>SynapsesStream::read() uses async read of synapse data of the given fraction of GIDs.</li>
<li>OPT: getProjectedSynapses() loads the synapses from the smaller GIDSet and uses the correct side (afferent/efferent) accordingly.</li>
</ul>
<h2>Issues</h2>
<h3>1: Why does the synapses container has to load on construction?</h3>
<p><em>Resolved: Yes</em></p>
<p>For an easier implemenation and a consistent API. Determining the size of the container already requires 'touching' all synapse datasets in the current file storage, hence loading attributes or positions in the same go does not waste more time. Regarding memory concerns, the stream approach helps there to only load synapses for a fraction of gids of interest.</p>
<h3>2: Why there are no set operators like in the BBPSDK synapse container?</h3>
<p><em>Resolved: Yes</em></p>
<p>Synapses::getProjectedSynapses() was the missing part in the SDK to render most of the set operations useless. It is a more optimized way of filtering. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="rfcs.html">RFCs</a></li>
    <li class="footer">Generated on Tue Jun 12 2018 06:16:14 for Brion by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
