<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>RTNeuron: Advanced usage and recipes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RTNeuron
   &#160;<span id="projectnumber">3.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('advanced.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Advanced usage and recipes </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p> 
<style type="text/css" media="screen, projection">
#note {
    position: relative;
}
#note span {
    display: none;
}
#note a span {
    display: none;
    color: #FFFFFF;
}
#note a span span {
    display: none;
}
#note a:hover span span {
    display: none;
}
#note a:hover span {
    display: block;
    position: absolute;
    width: 20em;
    background-color: #aaa;
    left: -21em;
    top: -5px;
    color: #FFFFFF;
    padding: 5px;
}

pre {
    padding: 0.5em;
    border: 1px dashed #2f6fab;
    color: black;
    background-color: #f9f9f9;
    line-height: 1em;
}
</style>
</p>
<h1><a class="anchor" id="stereo"></a>
Stereoscopic rendering</h1>
<h1><a class="anchor" id="levels_of_detail"></a>
Levels of detail</h1>
<h2><a class="anchor" id="available_lods"></a>
Level of detail representations</h2>
<p>RTNeuron implements five levels of detail (LOD) for neurons that can be combined to configure the representation to use for neurons at different distances.</p>
<p>These models are:</p><ul>
<li><b>Spheres for somas</b>: Perfect spheres are rendered efficiently using a ray-casting algorithm. This algorithm scales well to several millions of neurons. As a drawback, driver-based antialiasing does not work due to the raycast implementation. <div class="image">
<img src="lod_soma.png" alt="lod_soma.png"/>
<div class="caption">
Ray-cast sphere, the lowest level of detail for somas.</div></div>
</li>
<li><b>Detailed mesh for somas</b>:<a class="anchor" id="detailed_soma_mesh"></a>Extracted from the detailed polygonal mesh, this model includes the soma and initial portion of all the first order branches. Using this representation for somas implies loading the full mesh of the neuron. Note that the mesh is not deallocated after extracting the cell core. <div class="image">
<img src="lod_detailed_soma.png" alt="lod_detailed_soma.png"/>
<div class="caption">
Detailed soma geometry extracted from the polygonal mesh.</div></div>
</li>
<li><b>Detailed mesh</b>: In this representation the fully detailed polygonal mesh is used to represent the whole neuron membrane. <div class="image">
<img src="lod_mesh.png" alt="lod_mesh.png"/>
<div class="caption">
Detailed polygonal mesh.</div></div>
</li>
<li><b>Pseudo-cylinders</b>: This is a simple full neuron geometrical model that uses camera oriented quadrilaterals shaded to give an impression of generalized cylinders when seen from a distance. This model exhibits artifacts at branches that are orthogonal to the camera plane, but looks fine for models to be fit within a regular screen. This model can be extracted directly from the morphological skeletons. Pseudo cylinders can be rendered using two different tessellation levels. The higher detail version is a direct conversion of each morphological segment into a piece of geometry. This one is intended for detailed somas, but can also be used with spherical somas. By default, the model construction process tries to extract the cell core and connect the first order branches to the point in which they finish in the <a class="el" href="advanced.html#detailed_soma_mesh">detailed soma model</a>. If the mesh is not available or the scene has been created requesting not to load meshes, the first order branches start from the surface of the spherical soma. The lower detail version is obtained by subsampling the morphology skeleton and it is intended to be used in combination with spherical somas. <table  class="collapsed_table">
<tr>
<td><div class="image">
<img src="lod_low_cylinders.png" alt="lod_low_cylinders.png"/>
<div class="caption">
Low detail pseudo-cylinders with spherical soma</div></div>
 </td><td><div class="image">
<img src="lod_cylinders.png" alt="lod_cylinders.png"/>
<div class="caption">
High detail pseudo-cylinders with detailed soma</div></div>
 </td><td><div class="image">
<img src="lod_cylinders_no_mesh.png" alt="lod_cylinders_no_mesh.png"/>
<div class="caption">
High detail pseudo-cylinders with spherical soma</div></div>
  </td></tr>
</table>
Pseudo-cylinders can be shaded using two different techniques that offer different performance and visual results.</li>
<li><b>Tubelets</b>: This model uses spherically capped cone frusta, called tubelets, to represent the segments that form the neuronal skeleton. The tubelets are rendered using a ray-cast algorithm that only requires the end points and radii of each segment <span id="note"><a><sup>note</sup><span id="right"><span>(</span>
Some additional information directly derived from the morphological skeleton is
also needed for smooth shading and artifact-free transparent tubelets.
<span>)</span></span></a></span>. Two different shading methods are provided. The default one shades each tubelet independently. The second one interpolates the surface normals to smooth the boundary between segments; this shading style is enabled setting <code>smooth_tublets</code> to true in the AttributeMap passed to <a class="el" href="classbbp_1_1rtneuron_1_1RTNeuron.html#a6cf0ac856d6bb6cfea607f2ab587f30c">RTNeuron.createScene</a>. Driver based antialiasing does not work in this representation due to the raycasting implementation. If the neuron mesh is available, the first order branches start from the points where they end in the <a class="el" href="advanced.html#detailed_soma_mesh">detailed soma </a> (so both models are combined). If the mesh is not available or the scene has been created requesting not to load meshes, the first order branches start from the surface of the spherical soma. <table  class="collapsed_table">
<tr>
<td><div class="image">
<img src="lod_tubelets.png" alt="lod_tubelets.png"/>
<div class="caption">
Tubelets with detailed soma.</div></div>
 </td><td><div class="image">
<img src="lod_sharp_tubelets.png" alt="lod_sharp_tubelets.png"/>
<div class="caption">
Close-up of the default tubelet shading.</div></div>
 </td><td><div class="image">
<img src="lod_smooth_tubelets.png" alt="lod_smooth_tubelets.png"/>
<div class="caption">
Close-up of the smooth tubelet shading.</div></div>
  </td></tr>
</table>
</li>
</ul>
<p>All the models for whole morphologies support view frustum culling and branch order culling. More details on both techniques are given in <a class="el" href="advanced.html#culling">View frustum culling options</a>.</p>
<h2><a class="anchor" id="configuring_lods"></a>
Working with levels of detail.</h2>
<p>What LODs to use when building the representation of a neuron is a property of <a class="el" href="classbbp_1_1rtneuron_1_1Scene.html">Scenes</a>, while which models to choose to render a neuron from a given viewpoint is the combination of <a class="el" href="classbbp_1_1rtneuron_1_1View.html">View</a> and <a class="el" href="classbbp_1_1rtneuron_1_1Scene.html">Scene</a> properties.</p>
<h3><a class="anchor" id="static_lods"></a>
Specifying levels of detail.</h3>
<p>When a scene is created manually, it is possible to provide a LOD specification as part of the attribute map that holds the scene parameters. The LOD specification is itself an AttributeMap where the keys and the values are a pair of floating point numbers in the range [0, 1]. This interval is used to decide if a given LOD is visible or not depending on the screen resolution, bounding box of the neuron and its distance to the camera. Smaller values are used when the bounding box projects to a small area on the screen, while higher values are used for large projections (the actual formula used to select if a LOD is visible is an implementation detail and it is subject to change).</p>
<p>An example of manual setup of the LOD specification is given below: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment"># LOD specification that mimics the behavior of --no-lod</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;$ attributes = AttributeMap()</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;$ attributes.lod = AttributeMap()</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;$ attributes.lod.neurons = AttributeMap()</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;$ attributes.lod.neurons.mesh = [0, 1]</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;...</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;$ scene = app.createScene(attributes)</div></div><!-- fragment --><p>For automatic scenes RTNeuron creates a default LOD specification based on the command line options and provides it to the scene construction. Section <a class="el" href="advanced.html#default_lods">Default LOD specifications</a> provide details about it.</p>
<dl class="section note"><dt>Note</dt><dd>Automatic scenes are those created by RTNeuron when using <code>display_circuit</code> inside the shell or loading a circuit from the command line with the options <code>-b</code>, <code>--target</code>, <code>--neurons</code>, and <code>-n</code> (<code>--neuron</code>). Manual scenes are those created using <a class="el" href="classbbp_1_1rtneuron_1_1RTNeuron.html#a6cf0ac856d6bb6cfea607f2ab587f30c">RTNeuron.createScene</a> and assigning the <a class="el" href="classbbp_1_1rtneuron_1_1Scene.html">Scene </a> manually to a <a class="el" href="classbbp_1_1rtneuron_1_1View.html">View</a>. Scenes parameters are specified using the AttributeMap passed to <a class="el" href="classbbp_1_1rtneuron_1_1RTNeuron.html#a6cf0ac856d6bb6cfea607f2ab587f30c">RTNeuron.createScene</a>.</dd></dl>
<p>The environmental variable RTNEURON_LOD_CONFIG_FILE can be set to point to a file that contains a LOD specification to use for automatic scenes. The file may contain a LOD definition per line using this format: <code>lod_name start end</code>. Lines starting with # are ignored. The valid LOD names are the same as those used in the scene attribute map and the start and end values are also numbers between 0 and 1: </p><div class="fragment"><div class="line"><span class="preprocessor"># Example LOD config file</span></div><div class="line">low_detail_cylinders 0.0 0.5</div><div class="line">spherical_soma       0.0 0.5</div><div class="line">detailed_soma        0.5 1.0</div><div class="line">tubelets             0.5 1.0</div></div><!-- fragment --><h4><a class="anchor" id="avoiding_meshes"></a>
Avoiding meshes</h4>
<p>To avoid loading meshes, use <code>--no-meshes</code> for automatic scenes or set <code>use_meshes</code> to false in the attribute map passed to <a class="el" href="classbbp_1_1rtneuron_1_1RTNeuron.html#a6cf0ac856d6bb6cfea607f2ab587f30c">RTNeuron.createScene</a>. If meshes are not loaded, the detailed soma model is neither available, and tubelet and pseudo-cylinder first order branches always start from the spherical soma.</p>
<h4><a class="anchor" id="enabling_tubelets"></a>
Enabling tubelets</h4>
<p>Tubelets can be enabled with the command line option <code>--use-tubelets</code>. If provided, the automatic level of detail configuration will replace all references to high detail pseudo-cylinders with tubelets. This option has no effect if <code>--no-lod</code> or <code>--clod</code> are given.</p>
<h4><a class="anchor" id="clod"></a>
Continuous level of detail</h4>
<p>RTNeuron supports a simple implementation of continuous level of detail (CLOD) based on the combination of pseudocylinders and tubelets. The basis of the method is to render both models at the same time and for each morphological segment choose whether to use one model or the other at the geometry processing stage of the GPU pipeline. The selection is based on the thickness of the segment and its distance to the camera.</p>
<p>This is an experimental feature and its performance advantage has not been evaluated yet, however it provides a convenient way of rendering circuits without meshes having an acceptable result for close ups.</p>
<p>To enable CLOD for automatic scenes pass <code>--clod</code> in the command line. For manual scenes set the attribute <code>clod</code> to true in the attribute map <code>neurons</code> which describes the LOD specification.</p>
<h4><a class="anchor" id="default_lods"></a>
Default LOD specifications</h4>
<p>The default LOD specifications for automatic scenes are equivalent to the following ones:</p>
<p>If meshes are loaded and <code>--clod</code> is not used: </p><div class="fragment"><div class="line"><span class="preprocessor"># Default LOD specification</span></div><div class="line">mesh                  0.5 1.0</div><div class="line">high_detail_cylinders 0.3 0.5</div><div class="line">detailed_soma         0.3 0.5</div><div class="line">low_detail_cylinders  0.0 0.3</div><div class="line">spherical_soma        0.0 0.3</div></div><!-- fragment --><p> where <code>tubelets</code> is used instead of <code>high_detail_cylinders</code> if the option <code>--use-tubelets</code> is used.</p>
<p>If <code>--no-meshes</code> is given in the command line: </p><div class="fragment"><div class="line"><span class="preprocessor"># LOD specification if --no-meshes is used</span></div><div class="line">low_detail_cylinders 0.0 0.3</div><div class="line">spherical_soma 0.0 1</div><div class="line">high_detail_cylinders 0.3 1</div></div><!-- fragment --><p> where <code>tubelets</code> is used instead of <code>high_detail_cylinders</code> if the option <code>--use-tubelets</code> is used.</p>
<p>If <code>--clod</code> is given in the command line, the specification is the following regardless of : </p><div class="fragment"><div class="line"><span class="preprocessor"># LOD specification if --clod is used</span></div><div class="line">high_detail_cylinders 0 1</div><div class="line">tubelets 0 1</div><div class="line">detailed_soma 0 1</div></div><!-- fragment --><p> where <code>detailed_soma</code> is replaced by <code>spherical_soma</code> if <code>--no-meshes</code> is also provided.</p>
<h4><a class="anchor" id="disabling_lods"></a>
Disabling LODs</h4>
<p>If the option <code>--no-lod</code> is passed in the command line, not LODs are used at all, and all targets to be displayed in detailed representation mode will be rendered using the detailed meshes. This option has the highest prevalence above all the others.</p>
<h4><a class="anchor" id="soma_only_notes"></a>
Notes on soma only mode</h4>
<p>When using the <em>soma</em> <em>only</em> representation mode, morphologies will still be loaded to compute an appropriate sphere radius for each neuron. It is possible to not load morphologies and assign soma radii heuristically instead. In order to do so, use the command line option <code>--no-morphologies</code> for automatic scenes, or set <code>load_morphologies</code> to false in the attribute map passed to <a class="el" href="classbbp_1_1rtneuron_1_1RTNeuron.html#a6cf0ac856d6bb6cfea607f2ab587f30c">RTNeuron.createScene</a>. The soma radii are assigned based on the morphology types as indicated in the following table (all radii in microns): </p><table  style="margin-left: auto; margin-right: auto; text-align: center;">
<tr>
<th style="width: 25%">Inhibitory cells </th><th style="width: 25%">Excitatory cells </th></tr>
<tr style="vertical-align: top;">
<td><table  id="name_value_table">
<tr>
<td>ADC</td><td>7.72 </td></tr>
<tr>
<td>AHC</td><td>7.54 </td></tr>
<tr>
<td>BP</td><td>6.74 </td></tr>
<tr>
<td>BTC</td><td>9.15 </td></tr>
<tr>
<td>ChC</td><td>8.01 </td></tr>
<tr>
<td>CRC</td><td>7.28 </td></tr>
<tr>
<td>DBC</td><td>6.58 </td></tr>
<tr>
<td>LBC</td><td>9.28 </td></tr>
<tr>
<td>NBC</td><td>8.61 </td></tr>
<tr>
<td>NGC</td><td>7.46 </td></tr>
<tr>
<td>MC</td><td>9.37 </td></tr>
<tr>
<td>SBC</td><td>7.75 </td></tr>
</table>
</td><td><table  id="name_value_table">
<tr>
<td>L2PC</td><td>8.36 </td></tr>
<tr>
<td>L3PC</td><td>7.70 </td></tr>
<tr>
<td>L4PC</td><td>7.84 </td></tr>
<tr>
<td>L4SP</td><td>7.76 </td></tr>
<tr>
<td>L4SS</td><td>8.87 </td></tr>
<tr>
<td>L5STPC</td><td>8.61 </td></tr>
<tr>
<td>L5TTPC</td><td>11.17 </td></tr>
<tr>
<td>L5UTPC</td><td>9.75 </td></tr>
<tr>
<td>L6CCPC</td><td>7.71 </td></tr>
<tr>
<td>L6CLPC</td><td>7.32 </td></tr>
<tr>
<td>L6CTPC</td><td>7.00 </td></tr>
</table>
</td></tr>
</table>
<p>For unknown morphology types, a default soma radius of 9 microns is used. This value can be changed for automatic scenes using the command line option <code>--soma-radius <em>number</code></em>. From the shell, this value can only be changed setting the attribute <code>soma_radius</code> on the attribute map passed to the application object (<a class="el" href="classbbp_1_1rtneuron_1_1RTNeuron.html">RTNeuron</a>) constructor.</p>
<p>The default radii table cannot be modified for automatic scenes, but if you instantiate the application object (<a class="el" href="classbbp_1_1rtneuron_1_1RTNeuron.html">RTNeuron</a>) manually, you can provide your own one in the AttributeMap passed to the constructor. The table is also an AttributeMap and must be assigned to an attribute named <code>soma_radii</code>. The radii attribute map contains morphological type, radius pairs.</p>
<p>Currently, neither the radii table, nor the unknown type radius can be changed after creating the application object.</p>
<dl class="section warning"><dt>Warning</dt><dd>A shortcoming of the current design is that morphology names must be valid Python identifiers in order to use the syntax <code>table.name = radius</code>. This limitation come be overcome using the alternative syntax <code>table.__setattr__(name, radius)</code>.</dd></dl>
<p>The following code snippet shows an example of this usage and the image below an example of rendering which can be obtained this way: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ a = AttributeMap()</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;$ a.soma_radius = 2</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;$ radii = AttributeMap()</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;$ radii.L2PC = 10</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;...</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;$ a.soma_radii = soma_radii</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;$ app = RTNeuron(sys.argv, a)</div></div><!-- fragment --><div class="image">
<img src="column_exc_inh.png" alt="column_exc_inh.png"/>
<div class="caption">
Soma column rendered with different colors, transparencies and soma radius for inhibitory and excitatory neurons.</div></div>
<h3><a class="anchor" id="runtime_lods"></a>
Changing levels of detail.</h3>
<p>At runtime the LOD bias can be adjusted in a per view basis. This parameter is a View attribute called <code>lod_bias</code> and accessed from <a class="el" href="classbbp_1_1rtneuron_1_1View.html#a235b81ed53943b365790754bd4541eb3">View.attributes</a>.</p>
<p>The LOD bias is a value in the range [0, 1] which is transformed internally in a value in the range [0, +inf), where 0.5 maps to 1. This bias is applied during LOD selection as a multiplicative to factor of the screen area covered by each bounding box.</p>
<h1><a class="anchor" id="culling"></a>
View frustum culling options</h1>
<p>REVIEW</p>
<h1><a class="anchor" id="transparency"></a>
Transparency</h1>
<p>REVIEW</p>
<h1><a class="anchor" id="display_config"></a>
Display configuration</h1>
<p>REVIEW </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Documentation</a></li><li class="navelem"><a class="el" href="user_guide.html">User Guide</a></li>
    <li class="footer">Generated on Thu Sep 13 2018 07:24:01 for RTNeuron by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
